import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import OpenAI from 'openai'

function getSupabaseClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY
  
  if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase credentials:', {
      hasUrl: !!supabaseUrl,
      hasKey: !!supabaseKey
    })
    throw new Error('Supabase credentials not configured')
  }
  
  return createClient(supabaseUrl, supabaseKey)
}

function getOpenAIClient() {
  return new OpenAI({
    apiKey: process.env.OPENAI_API_KEY!
  })
}

export async function POST(request: NextRequest) {
  const supabase = getSupabaseClient()
  const openai = getOpenAIClient()
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
  console.log('üöÄ [ENRICH] Iniciando enriquecimiento de √°rea')
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
  
  try {
    // Validar API keys al inicio
    console.log('üîë [ENRICH] Validando API keys...')
    console.log('  - OPENAI_API_KEY:', process.env.OPENAI_API_KEY ? '‚úÖ Configurada' : '‚ùå NO configurada')
    console.log('  - SERPAPI_KEY:', process.env.SERPAPI_KEY ? '‚úÖ Configurada' : '‚ùå NO configurada')
    
    if (!process.env.OPENAI_API_KEY) {
      console.error('‚ùå [ENRICH] Error: OPENAI_API_KEY no configurada')
      return NextResponse.json({
        error: 'OPENAI_API_KEY no configurada',
        details: 'A√±ade OPENAI_API_KEY al archivo .env.local',
        errorType: 'CONFIG_ERROR'
      }, { status: 500 })
    }

    if (!process.env.SERPAPI_KEY) {
      console.error('‚ùå [ENRICH] Error: SERPAPI_KEY no configurada')
      return NextResponse.json({
        error: 'SERPAPI_KEY no configurada',
        details: 'A√±ade SERPAPI_KEY al archivo .env.local',
        errorType: 'CONFIG_ERROR'
      }, { status: 500 })
    }

    const { areaId } = await request.json()
    console.log('üìù [ENRICH] Area ID recibido:', areaId)

    if (!areaId) {
      return NextResponse.json({ error: 'Area ID es requerido' }, { status: 400 })
    }

    // Obtener el √°rea de la base de datos
    console.log('üîç [ENRICH] Buscando √°rea en base de datos...')
    const { data: area, error: areaError } = await supabase
      .from('areas')
      .select('*')
      .eq('id', areaId)
      .single()

    if (areaError || !area) {
      console.error('‚ùå [ENRICH] Error: √Årea no encontrada', areaError)
      return NextResponse.json({ error: '√Årea no encontrada' }, { status: 404 })
    }

    console.log('‚úÖ [ENRICH] √Årea encontrada:', area.nombre, '-', area.ciudad)
    console.log('  - Descripci√≥n actual:', area.descripcion ? `${area.descripcion.substring(0, 50)}...` : 'Sin descripci√≥n')

    // Si ya tiene descripci√≥n, no sobrescribir (a menos que se fuerce)
    if (area.descripcion && area.descripcion.length > 100) {
      console.log('‚ö†Ô∏è [ENRICH] El √°rea ya tiene descripci√≥n (>100 caracteres). No se sobrescribe.')
      return NextResponse.json({
        success: false,
        message: 'El √°rea ya tiene una descripci√≥n. No se sobrescribe.'
      })
    }

    console.log('‚úÖ [ENRICH] √Årea v√°lida para enriquecer. Continuando...')

    // Buscar informaci√≥n del √°rea y la localidad con SerpAPI
    // Usar comillas para b√∫squeda exacta de ciudad
    const query = `"${area.ciudad}" ${area.provincia} turismo autocaravanas qu√© ver`
    const serpApiUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&api_key=${process.env.SERPAPI_KEY}&location=Spain&hl=es&gl=es&num=10`

    console.log('üîé [ENRICH] Llamando a SerpAPI...')
    console.log('  - √Årea:', area.nombre, '-', area.ciudad, area.provincia)
    console.log('  - Query:', query)

    let serpResponse
    try {
      serpResponse = await fetch(serpApiUrl)
      console.log('  - SerpAPI HTTP Status:', serpResponse.status)
    } catch (fetchError: any) {
      console.error('‚ùå [ENRICH] Error de red con SerpAPI:', fetchError.message)
      return NextResponse.json({
        error: 'Error conectando con SerpAPI',
        details: fetchError.message,
        errorType: 'NETWORK_ERROR'
      }, { status: 500 })
    }

    const serpData = await serpResponse.json()

    // Verificar si SerpAPI devolvi√≥ error
    if (serpData.error) {
      console.error('‚ùå [ENRICH] Error de SerpAPI:', serpData.error)
      return NextResponse.json({
        error: 'Error de SerpAPI',
        details: serpData.error,
        errorType: 'SERPAPI_ERROR'
      }, { status: 500 })
    }

    console.log('‚úÖ [ENRICH] SerpAPI respondi√≥ correctamente')
    console.log('  - Resultados org√°nicos:', serpData.organic_results?.length || 0)

    // FILTRAR resultados que NO sean de la ciudad correcta
    if (serpData.organic_results && serpData.organic_results.length > 0) {
      const ciudadLower = area.ciudad.toLowerCase()
      const resultadosOriginales = serpData.organic_results.length
      
      serpData.organic_results = serpData.organic_results.filter((result: any) => {
        const snippet = (result.snippet || '').toLowerCase()
        const title = (result.title || '').toLowerCase()
        
        // Mantener solo resultados que mencionen la ciudad correcta
        return snippet.includes(ciudadLower) || title.includes(ciudadLower)
      })
      
      console.log(`  - Filtrado por ciudad "${area.ciudad}": ${resultadosOriginales} ‚Üí ${serpData.organic_results.length} resultados`)
    }

    // Extraer informaci√≥n relevante
    let contexto = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è √ÅREA ESPEC√çFICA QUE DEBES DESCRIBIR:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Nombre del √°rea: ${area.nombre}
Ciudad: ${area.ciudad}
Provincia: ${area.provincia}
Pa√≠s: ${area.pais}
Tipo: ${area.tipo_area}
`
    
    if (area.precio_por_noche) {
      contexto += `Precio: ${area.precio_por_noche}‚Ç¨/noche\n`
    } else {
      contexto += `Precio: Gratis o desconocido\n`
    }

    if (area.plazas_disponibles) {
      contexto += `Plazas disponibles: ${area.plazas_disponibles}\n`
    }

    if (area.servicios && typeof area.servicios === 'object') {
      const serviciosDisponibles = Object.entries(area.servicios)
        .filter(([_, value]) => value === true)
        .map(([key]) => key)
      
      if (serviciosDisponibles.length > 0) {
        contexto += `\n‚úÖ Servicios confirmados: ${serviciosDisponibles.join(', ')}\n`
      } else {
        contexto += `\n‚ö†Ô∏è No hay servicios confirmados para esta √°rea.\n`
      }
    }

    contexto += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
INFORMACI√ìN TUR√çSTICA DE ${area.ciudad.toUpperCase()}:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
(Esta informaci√≥n es solo sobre ${area.ciudad}, NO sobre otras ciudades)

`

    if (serpData.organic_results) {
      serpData.organic_results.forEach((result: any) => {
        contexto += `${result.title}\n${result.snippet}\n\n`
      })
    }

    if (serpData.answer_box) {
      contexto += `${serpData.answer_box.snippet || serpData.answer_box.answer}\n\n`
    }

    // Obtener configuraci√≥n del agente desde la BD
    const { data: configData } = await supabase
      .from('ia_config')
      .select('config_value')
      .eq('config_key', 'enrich_description')
      .single()

    const config = configData?.config_value || {
      model: 'gpt-4o-mini',
      temperature: 0.7,
      max_tokens: 1500,
      prompts: [
        {
          id: 'sys-1',
          role: 'system',
          content: 'Eres un redactor experto en gu√≠as de viaje para autocaravanas. Escribes textos informativos, naturales y bien estructurados en espa√±ol.',
          order: 1,
          required: true
        }
      ]
    }

    // Construir mensajes para OpenAI desde los prompts configurados
    const messages = config.prompts
      .sort((a: any, b: any) => a.order - b.order)
      .map((prompt: any) => {
        // Reemplazar variables en el contenido del prompt
        let content = prompt.content
          .replace(/\{\{contexto\}\}/g, contexto)
          .replace(/\{\{area_nombre\}\}/g, area.nombre)
          .replace(/\{\{area_ciudad\}\}/g, area.ciudad)
          .replace(/\{\{area_provincia\}\}/g, area.provincia)
        
        return {
          role: prompt.role === 'agent' ? 'user' : prompt.role,
          content: content
        }
      })

    // Prompt para generar el texto descriptivo (fallback si no hay prompts configurados)
    const prompt = messages.length > 1 ? messages[messages.length - 1].content : `Eres un redactor especializado en autocaravanas, campers y viajes. 
Tu misi√≥n es crear contenido detallado para un Mapa de √Åreas de Autocaravanas dirigido a viajeros en autocaravanas, caravanas y campers.

INFORMACI√ìN QUE TIENES:
${contexto}

TU TAREA:
Crear un texto extenso y detallado (400-600 palabras) que combine:
1. Informaci√≥n espec√≠fica del √°rea de autocaravanas
2. Gu√≠a tur√≠stica de la localidad y zona pr√≥xima
3. Informaci√≥n pr√°ctica para el viajero

REGLAS ESTRICTAS:
‚úì Informaci√≥n veraz y contrastada basada en el contexto proporcionado.
‚úì Sobre SERVICIOS: Solo menciona los servicios que aparecen en "Servicios confirmados disponibles". Si no hay servicios confirmados, NO hables de servicios espec√≠ficos.
‚úì Si no tienes informaci√≥n sobre servicios, c√©ntrate en el entorno, la localidad, atractivos tur√≠sticos, gastronom√≠a, historia, etc.
‚úì Siempre di "el √°rea de autocaravanas" (nunca "esta √°rea").
‚úì Tono informativo y √∫til, sin ser excesivamente pomposo.
‚úì Escribe en espa√±ol de forma natural y fluida.

NUNCA, BAJO NING√öN CONCEPTO:
‚úó Mencionar la direcci√≥n del √°rea (ya est√° en el mapa).
‚úó Usar frases como "no dispongo de informaci√≥n", "no he encontrado informaci√≥n", "no existe informaci√≥n".
‚úó Usar frases como "Aunque la informaci√≥n sobre la disponibilidad de servicios no est√° claramente especificada".
‚úó Recomendar "verificar los servicios en el momento de la visita".
‚úó Inventar o suponer servicios con expresiones como "posiblemente", "probablemente", "suele tener".
‚úó Decir constantemente "destino ideal", "maravilloso", etc.
‚úó Mencionar servicios que NO est√°n en la lista de "Servicios confirmados disponibles".

ESTRUCTURA SUGERIDA:
1. Introducci√≥n al √°rea y su ubicaci√≥n
2. Informaci√≥n del √°rea (plazas, precio solo si est√° confirmado, servicios solo si est√°n confirmados)
3. Entorno y localidad cercana
4. Atractivos tur√≠sticos de la zona
5. Informaci√≥n pr√°ctica (acceso, mejor √©poca, recomendaciones)

Escribe un texto completo, bien redactado y natural. NO uses listas de puntos, escribe en p√°rrafos.`

    // Llamar a OpenAI con manejo de errores mejorado
    console.log('ü§ñ [ENRICH] Llamando a OpenAI...')
    console.log('  - Modelo:', config.model)
    console.log('  - Temperature:', config.temperature)
    console.log('  - Max tokens:', config.max_tokens)
    console.log('  - N√∫mero de mensajes:', messages.length)
    
    let completion
    try {
      completion = await openai.chat.completions.create({
        model: config.model,
        messages: messages,
        temperature: config.temperature,
        max_tokens: config.max_tokens
      })
      console.log('‚úÖ [ENRICH] OpenAI respondi√≥ correctamente')
      console.log('  - Tokens usados:', completion.usage?.total_tokens || '?')
    } catch (openaiError: any) {
      console.error('‚ùå [ENRICH] Error de OpenAI:', openaiError.message)
      if (openaiError.status === 401) {
        return NextResponse.json({
          error: 'OpenAI API Key inv√°lida',
          details: 'La API key de OpenAI no es v√°lida. Verifica OPENAI_API_KEY en .env.local',
          errorType: 'AUTH_ERROR'
        }, { status: 401 })
      }
      
      if (openaiError.status === 429) {
        return NextResponse.json({
          error: 'L√≠mite de OpenAI alcanzado',
          details: 'Has superado tu cuota o l√≠mite de peticiones. Espera unos minutos o aumenta tu l√≠mite en OpenAI.',
          errorType: 'RATE_LIMIT'
        }, { status: 429 })
      }

      if (openaiError.status === 400) {
        return NextResponse.json({
          error: 'Petici√≥n inv√°lida a OpenAI',
          details: openaiError.message || 'Verifica la configuraci√≥n del prompt',
          errorType: 'VALIDATION_ERROR'
        }, { status: 400 })
      }

      return NextResponse.json({
        error: 'Error de OpenAI',
        details: openaiError.message || 'Error desconocido',
        errorType: 'OPENAI_ERROR'
      }, { status: 500 })
    }

    const descripcionGenerada = completion.choices[0].message.content || ''

    console.log('üìù [ENRICH] Descripci√≥n generada (' + descripcionGenerada.length + ' caracteres)')
    console.log('  - Primeros 100 caracteres:', descripcionGenerada.substring(0, 100) + '...')

    // Actualizar en la base de datos
    console.log('üíæ [ENRICH] Guardando en base de datos...')
    const { error: updateError } = await supabase
      .from('areas')
      .update({
        descripcion: descripcionGenerada,
        updated_at: new Date().toISOString()
      })
      .eq('id', areaId)

    if (updateError) {
      console.error('‚ùå [ENRICH] Error al guardar en BD:', updateError)
      throw updateError
    }

    console.log('‚úÖ [ENRICH] ¬°Descripci√≥n guardada exitosamente!')
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')

    return NextResponse.json({
      success: true,
      descripcion: descripcionGenerada,
      fuente: 'SerpAPI + OpenAI'
    })

  } catch (error: any) {
    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
    console.error('‚ùå [ENRICH] ERROR CR√çTICO:', error)
    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ')
    return NextResponse.json(
      { 
        error: error.message || 'Error procesando el √°rea',
        details: error.stack?.split('\n')[0] || 'Sin detalles adicionales',
        errorType: 'UNKNOWN_ERROR'
      },
      { status: 500 }
    )
  }
}

